angular.module("app").factory("searchBarService",["configurationService","closedSignService",function(e,n){var r=e.searchBarService,t={},a=function(e,n){if(n)var r=t.suggestionsRelated;else var r=t.productsRelated;var a=e.split(" "),c="";return _.each(a,function(e){_.each(r,function(n){var r=!1;_.each(n,function(t){e===t&&(r=!0,_.each(n,function(e){c+=" "+e}))})})}),c},c=function(e){var n=function(e){return"s"===e.slice(-1)&&(e=e.slice(0,-1)),e};e=o(e);var t=e.split(" "),a=r.articles,c=[];return _.each(t,function(e){_.indexOf(a,e)<0&&(e=n(e),c.push(e))}),c},o=function(e){var n=e.toLowerCase(),n=_.deburr(n);return n},i=function(e,n){n=n.replace(/(^[\s]+|[\s]+$)/g,""),e=e.replace(/(^[\s]+|[\s]+$)/g,"");var r;return e==n&&(r=!0),r},u=function(e,n,r){var t=!0,c=o(e.producto);if(e.categoria[0]){var i=" "+e.categoria[0].nombre;c+=i}return void 0!=a(c,r)&&(c+=" "+a(c,r)),_.each(n,function(e){var n=new RegExp("\\b"+e,"i");-1==c.search(n)&&(t=!1)}),t},s=function(e,n,r){var t=_.find(r.allClients,["id",n.cliente[0].id]),a=[];return _.each(r.allHours,function(n){n.cliente[0]&&n.cliente[0].cliente===e&&a.push(n)}),{client:t,matchedProducts:[],hours:a}},l=function(e){console.log(e);var n=_.groupBy(e,function(e){return!0===e.openData.isOpen?"open":void 0!=e.openData.openTime?"openLater":"closed"});return n.open=_.shuffle(n.open),n.openLater=_.sortBy(n.openLater,[function(e){return e.openData.openTime}]),n},d={};return d.noResults=function(e){var n=void 0!=e.open&&e.open.length>0,r=void 0!=e.openLater&&e.openLater.length>0,t=void 0!=e.closed&&e.closed.length>0;return!(n||r||t)},d.getMatches=function(e,r,a){t=e;var o=c(r),d=[],p=[];_.each(e.allProducts,function(t){var c=t.cliente[0].cliente,l=u(t,o,a);if(void 0!=c){var d=i(c,r);(l||d)&&(c in p||(p[c]=s(c,t,e),p[c].openData=n.getData(p[c])),p[c].matchedProducts.push(t))}});for(client in p)p[client].matchedProducts=_.sortBy(p[client].matchedProducts,[function(e){return void 0!=e.categoria[0]?e.categoria[0].nombre:e.producto}]),p[client].matchedProducts.find&&p[client].matchedProducts.find(function(e){if(void 0!=e.categoria[0]&&(primeraPalabra=e.categoria[0].nombre.split(" ")[0],terceraPalabra=e.categoria[0].nombre.split(" ")[2],!("Descuentos"!=primeraPalabra&&"descuentos"!=primeraPalabra||"Promociones"!=terceraPalabra&&"promociones"!=terceraPalabra))){var n=_.indexOf(p[client].matchedProducts,e),r=p[client].matchedProducts[n];p[client].matchedProducts.splice(n,1),p[client].matchedProducts.splice(0,0,r)}}),d.push(p[client]);return l(d)},d}]);